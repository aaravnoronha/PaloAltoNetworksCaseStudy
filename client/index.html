<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFin AI - Your Personal Financial Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #1F2937;
            --light: #F3F4F6;
            --white: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-connected {
            background: var(--secondary);
            color: white;
        }

        .status-disconnected {
            background: var(--danger);
            color: white;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .summary-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--dark);
            margin-top: 4px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .icon-primary { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .icon-secondary { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .icon-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .icon-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .insight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .insight-type-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .insight-type-info {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .insight-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .insight-text {
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.95;
            margin-bottom: 10px;
        }

        .insight-recommendation {
            font-size: 13px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-top: 10px;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .market-item {
            padding: 15px;
            background: var(--light);
            border-radius: 10px;
            text-align: center;
        }

        .market-symbol {
            font-weight: bold;
            font-size: 14px;
            color: var(--dark);
        }

        .market-value {
            font-size: 18px;
            font-weight: bold;
            margin: 5px 0;
        }

        .market-change {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .positive {
            color: var(--secondary);
            background: rgba(16, 185, 129, 0.1);
        }

        .negative {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .category-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #E5E7EB;
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-name {
            font-size: 14px;
            font-weight: 500;
        }

        .category-stats {
            text-align: right;
        }

        .category-amount {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }

        .category-count {
            font-size: 12px;
            color: #666;
        }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: var(--light);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4F46E5, #7C3AED);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-merchant {
            font-weight: 500;
            font-size: 14px;
            color: var(--dark);
        }

        .transaction-date {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .transaction-category {
            font-size: 11px;
            color: var(--primary);
            background: rgba(79, 70, 229, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 4px;
        }

        .transaction-amount {
            font-weight: 600;
            font-size: 15px;
        }

        .economic-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .economic-item {
            padding: 10px;
            background: rgba(79, 70, 229, 0.05);
            border-radius: 8px;
        }

        .economic-label {
            font-size: 12px;
            color: #666;
        }

        .economic-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.5s ease;
        }

        .alert-info {
            background: rgba(79, 70, 229, 0.1);
            border-left: 4px solid var(--primary);
            color: var(--dark);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--secondary);
            color: var(--dark);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--danger);
            color: var(--dark);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .summary-stats {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <span class="status-indicator"></span>
        <span id="statusText">Connecting...</span>
    </div>

    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <span>🤖</span>
                    <span>SmartFin AI</span>
                </div>
                <div class="summary-stats" id="summaryStats">
                    <div class="stat-item">
                        <div class="stat-label">Total Spent (30d)</div>
                        <div class="stat-value" id="totalSpent">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Transactions</div>
                        <div class="stat-value" id="transactionCount">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg Transaction</div>
                        <div class="stat-value" id="avgTransaction">--</div>
                    </div>
                </div>
            </div>
        </header>

        <div id="alerts"></div>

        <div class="dashboard">
            <!-- AI Insights -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">AI Insights</h3>
                    <div class="icon icon-primary">🧠</div>
                </div>
                <div id="insightsContainer">
                    <div class="loading"></div>
                </div>
            </div>

            <!-- Market Overview -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Market Overview</h3>
                    <div class="icon icon-secondary">📈</div>
                </div>
                <div id="marketContainer" class="market-grid">
                    <div class="loading"></div>
                </div>
            </div>

            <!-- Spending by Category -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Spending Categories</h3>
                    <div class="icon icon-warning">📊</div>
                </div>
                <div id="categoriesContainer" class="category-list">
                    <div class="loading"></div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Transactions</h3>
                    <div class="icon icon-danger">💳</div>
                </div>
                <div id="transactionsContainer" class="transaction-list">
                    <div class="loading"></div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="loadMoreTransactions()">
                    Load More
                </button>
            </div>

            <!-- Economic Indicators -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Economic Indicators</h3>
                    <div class="icon icon-primary">🏦</div>
                </div>
                <div id="economicContainer" class="economic-grid">
                    <div class="loading"></div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Quick Actions</h3>
                    <div class="icon icon-secondary">⚡</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-primary" onclick="refreshData()">Refresh Data</button>
                    <button class="btn btn-secondary" onclick="downloadReport()">Download Report</button>
                    <input type="file" id="csvUpload" accept=".csv" style="display: none;" onchange="uploadCSV(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('csvUpload').click()">
                        Upload Transactions (CSV)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'http://localhost:3000/api';
        let transactionOffset = 0;
        const transactionLimit = 20;

        // Initialize application
        async function init() {
            try {
                // Check server connection
                await checkConnection();
                
                // Load initial data
                await Promise.all([
                    loadSummary(),
                    loadInsights(),
                    loadMarketData(),
                    loadTransactions(),
                    loadEconomicIndicators()
                ]);
                
                // Set up auto-refresh for market data
                setInterval(loadMarketData, 30000); // Refresh every 30 seconds
                
                showAlert('success', '✅ Connected to SmartFin AI server');
            } catch (error) {
                console.error('Initialization error:', error);
                showAlert('error', '❌ Failed to connect to server. Please ensure the server is running.');
                updateConnectionStatus(false);
            }
        }

        // Check server connection
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.success) {
                    updateConnectionStatus(true);
                    return true;
                }
                throw new Error('Server unhealthy');
            } catch (error) {
                updateConnectionStatus(false);
                throw error;
            }
        }

        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusEl.className = 'connection-status status-connected';
                statusText.textContent = 'Connected';
            } else {
                statusEl.className = 'connection-status status-disconnected';
                statusText.textContent = 'Disconnected';
            }
        }

        // Load financial summary
        async function loadSummary() {
            try {
                const response = await fetch(`${API_BASE}/summary`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('totalSpent').textContent = `${data.totalSpent.toFixed(2)}`;
                    document.getElementById('transactionCount').textContent = data.transactionCount;
                    document.getElementById('avgTransaction').textContent = `${data.averageTransaction.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Failed to load summary:', error);
            }
        }

        // Load AI insights
        async function loadInsights() {
            try {
                const response = await fetch(`${API_BASE}/insights`);
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('insightsContainer');
                    const insights = result.data.insights;
                    
                    container.innerHTML = insights.map(insight => `
                        <div class="insight-box ${insight.type === 'warning' ? 'insight-type-warning' : 
                                                  insight.type === 'info' ? 'insight-type-info' : ''}">
                            <div class="insight-title">${insight.title}</div>
                            <div class="insight-text">${insight.description}</div>
                            ${insight.recommendation ? 
                                `<div class="insight-recommendation">💡 ${insight.recommendation}</div>` : ''}
                            ${insight.potentialSavings ? 
                                `<div class="insight-text">💰 Annual savings potential: ${insight.potentialSavings.toFixed(2)}</div>` : ''}
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load insights:', error);
            }
        }

        // Load market data
        async function loadMarketData() {
            try {
                const response = await fetch(`${API_BASE}/market`);
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('marketContainer');
                    const indices = result.data.indices;
                    
                    container.innerHTML = indices.map(index => `
                        <div class="market-item">
                            <div class="market-symbol">${index.symbol}</div>
                            <div class="market-value">${index.value.toFixed(2)}</div>
                            <div class="market-change ${index.change > 0 ? 'positive' : 'negative'}">
                                ${index.change > 0 ? '▲' : '▼'} ${Math.abs(index.changePercent).toFixed(2)}%
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load market data:', error);
            }
        }

        // Load transactions
        async function loadTransactions() {
            try {
                const response = await fetch(`${API_BASE}/transactions?limit=${transactionLimit}&offset=${transactionOffset}`);
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('transactionsContainer');
                    const transactions = result.data.transactions;
                    const categories = {};
                    
                    // Build categories summary
                    transactions.forEach(t => {
                        if (!categories[t.category]) {
                            categories[t.category] = { total: 0, count: 0 };
                        }
                        categories[t.category].total += t.amount;
                        categories[t.category].count++;
                    });
                    
                    // Update categories display
                    const categoriesContainer = document.getElementById('categoriesContainer');
                    const maxAmount = Math.max(...Object.values(categories).map(c => c.total));
                    
                    categoriesContainer.innerHTML = Object.entries(categories)
                        .sort((a, b) => b[1].total - a[1].total)
                        .map(([category, data]) => {
                            const percentage = (data.total / maxAmount) * 100;
                            return `
                                <div class="category-item">
                                    <div class="category-info">
                                        <div class="category-name">${category}</div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                    <div class="category-stats">
                                        <div class="category-amount">${data.total.toFixed(2)}</div>
                                        <div class="category-count">${data.count} transactions</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    
                    // Update transactions display
                    const transactionHtml = transactions.map(t => `
                        <div class="transaction-item">
                            <div class="transaction-details">
                                <div class="transaction-merchant">${t.merchant}</div>
                                <div class="transaction-date">${new Date(t.date).toLocaleDateString()}</div>
                                <span class="transaction-category">${t.category}</span>
                            </div>
                            <div class="transaction-amount">-${t.amount.toFixed(2)}</div>
                        </div>
                    `).join('');
                    
                    if (transactionOffset === 0) {
                        container.innerHTML = transactionHtml;
                    } else {
                        container.innerHTML += transactionHtml;
                    }
                }
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }

        // Load economic indicators
        async function loadEconomicIndicators() {
            try {
                const response = await fetch(`${API_BASE}/economic-indicators`);
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('economicContainer');
                    const indicators = result.data;
                    
                    container.innerHTML = `
                        <div class="economic-item">
                            <div class="economic-label">Inflation Rate</div>
                            <div class="economic-value">${indicators.inflationRate}%</div>
                        </div>
                        <div class="economic-item">
                            <div class="economic-label">Fed Funds Rate</div>
                            <div class="economic-value">${indicators.federalFundsRate}%</div>
                        </div>
                        <div class="economic-item">
                            <div class="economic-label">30Y Mortgage</div>
                            <div class="economic-value">${indicators.mortgageRate30Y}%</div>
                        </div>
                        <div class="economic-item">
                            <div class="economic-label">Savings Rate</div>
                            <div class="economic-value">${indicators.savingsRate}%</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load economic indicators:', error);
            }
        }

        // Load more transactions
        function loadMoreTransactions() {
            transactionOffset += transactionLimit;
            loadTransactions();
        }

        // Refresh all data
        async function refreshData() {
            showAlert('info', '🔄 Refreshing data...');
            transactionOffset = 0;
            await init();
        }

        // Download report
        function downloadReport() {
            showAlert('info', '📊 Generating report...');
            // In a real implementation, this would call an API endpoint to generate a PDF/CSV report
            setTimeout(() => {
                showAlert('success', '✅ Report downloaded successfully!');
            }, 2000);
        }

        // Upload CSV
        async function uploadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showAlert('info', `📁 Uploading ${file.name}...`);
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csv = e.target.result;
                    const response = await fetch(`${API_BASE}/upload-csv`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain'
                        },
                        body: csv
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showAlert('success', `✅ Uploaded ${result.data.transactionsAdded} transactions successfully!`);
                        await refreshData();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showAlert('error', '❌ Failed to upload CSV: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // Show alert
        function showAlert(type, message) {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        }

        // Initialize on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>
